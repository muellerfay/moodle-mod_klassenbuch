YUI.add("moodle-klassenbuchtool_lernschritte-edittable",function(e,t){M.klassenbuch_lernschritte=M.klassenbuch_lernschritte||{},NS=M.klassenbuch_lernschritte,NS.init=function(t){function i(e){return Number(e.data.duration)+"&nbsp;mins"}function s(e){f(e.td),l()}function o(r){var i={};i.action="updatesortorder",i.chapterid=t.chapterid,i.module=t.module,i.sesskey=M.cfg.sesskey;var s=[];n.data.each(function(e,t){s[t]=e.get("id")}),i.sortorder=s.join(",");var o=M.util.add_lightbox(e,r),u=M.cfg.wwwroot+t.ajaxurl;e.io(u,{method:"POST",data:i,on:{start:function(){o.show()},success:function(t,n){try{var r=e.JSON.parse(n.responseText);r.error&&new M.core.ajaxException(r)}catch(i){}window.setTimeout(function(){o.hide()},250)},failure:function(e,t){alert(t),o.hide()}}})}function u(){e.DataTable.EditorOptions.time={BaseViewClass:e.DataTable.BaseCellPopupEditor,name:"time",templateObject:{html:'<input type="text" title="inline cell editor" class="<%= this.classInput %>"  />'},inputKeys:!0,keyFiltering:/\d|\:/,validator:/^(\d{1,2})(\:)(\d{2})$/,saveFn:function(e){var t=this.get("validator"),n;return t instanceof RegExp?n=t.test(e)?e:undefined:n=e,n},after:{editorShow:function(e){e.inputNode.focus(),e.inputNode.select()}}},e.DataTable.EditorOptions.textarea.after={editorShow:function(e){e.inputNode.focus(),e.inputNode.select(),e.value===""&&e.inputNode.set("value","")}},n=new e.DataTable({columns:[{key:"id",label:"id",editable:!1},{key:"options",label:M.str.klassenbuchtool_lernschritte.options,editable:!1,allowHTML:!0,formatter:function(e){return e.data.savestatus&&e.data.savestatus==="unsaved"&&(e.rowClass="unsaved"),e.data.options.value}},{key:"attendancetype",label:M.str.klassenbuchtool_lernschritte.attendancetype,editor:"select",editorConfig:{selectOptions:t.options.attendancetype}},{key:"starttime",label:M.str.klassenbuchtool_lernschritte.starttime,editor:"time"},{key:"duration",label:M.str.klassenbuchtool_lernschritte.duration,formatter:i,allowHTML:!0},{key:"learninggoal",label:M.str.klassenbuchtool_lernschritte.learninggoal,editor:"textarea"},{key:"learningcontent",label:M.str.klassenbuchtool_lernschritte.learningcontent,editor:"textarea"},{key:"collaborationtype",label:M.str.klassenbuchtool_lernschritte.collaborationtype,editor:"select",editorConfig:{selectOptions:t.options.collaborationtype}},{key:"learnersactivity",label:M.str.klassenbuchtool_lernschritte.learnersactivity,editor:"textarea"},{key:"teachersactivity",label:M.str.klassenbuchtool_lernschritte.teachersactivity,editor:"textarea"},{key:"usedmaterials",label:M.str.klassenbuchtool_lernschritte.usedmaterials,editor:"textarea"},{key:"homework",label:M.str.klassenbuchtool_lernschritte.homework,editor:"textarea"}],data:t.data,editable:!0,defaultEditor:"text",editOpenType:"click"}),t.nooptions&&n.removeColumn("options"),n.render("#dtable"),n.after("cellEditorSave",function(e){s(e)});var r=n.get("boundingBox").one(".yui3-datatable-data"),u=r.one("tr"),a=-1;u&&(a=r.one("tr").get("rowIndex"));var f=-1,c=-1,h=new e.Sortable({container:r,nodes:"tr",opacity:".1"});h.delegate.after("drag:start",function(){var e=h.delegate.get("currentNode").get("rowIndex");f=e-a}),h.delegate.after("drag:end",function(){var e=h.delegate.get("currentNode").get("rowIndex");c=e-a;var t=n.get("data");t.add(t.remove(f),{index:c,silent:!0}),t.reset(t),h.sync(),o(h.delegate.get("currentNode")),l()})}function a(r){if(confirm(M.str.klassenbuchtool_lernschritte.confirmdelete)){var i=r.ancestor("tr"),s=i.getAttribute("data-yui3-record"),o=n.getRecord(s),u={};u.action="delete",u.chapterid=t.chapterid,u.module=t.module,u.sesskey=M.cfg.sesskey,u.id=o.get("id");var a=[];n.data.each(function(e,t){var n=e.get("id");e.id!==n&&(a[t]=n)}),u.sortorder=a.join(",");var f=M.util.add_lightbox(e,r),c=M.cfg.wwwroot+t.ajaxurl;e.io(c,{method:"POST",data:u,on:{start:function(){f.show()},success:function(t,r){try{var i=e.JSON.parse(r.responseText);i.error?new M.core.ajaxException(i):(n.removeRow(s),l())}catch(o){}window.setTimeout(function(){f.hide()},250)},failure:function(e,t){alert(t),f.hide()}}})}}function f(r){var i=r.ancestor("tr"),s=i.getAttribute("data-yui3-record"),o=n.getRecord(s),u={};u.action="save",u.chapterid=t.chapterid,u.module=t.module,u.sesskey=M.cfg.sesskey;for(var a=0;a<t.colkeys.length;a++)u[t.colkeys[a]]=o.get(t.colkeys[a]);var f=[];n.data.each(function(e,t){f[t]=e.get("id")}),u.sortorder=f.join(",");var c=M.util.add_lightbox(e,r),h=M.cfg.wwwroot+t.ajaxurl;e.io(h,{method:"POST",data:u,on:{start:function(){c.show()},success:function(t,r){try{var i=e.JSON.parse(r.responseText);i.error?new M.core.ajaxException(i):(n.modifyRow(s,{id:i.lernschritt.id}),o.set("savestatus","saved"),l())}catch(u){}window.setTimeout(function(){c.hide()},250)},failure:function(e,t){alert(t),c.hide()}}})}function l(){h()}function c(){var e="00:00";try{var i=n.data.item(n.data.size()-1),s=i.get("starttime"),o=i.get("duration"),u=s.split(":"),a=Number(u[0])*60+Number(u[1])+Number(o),f=Math.floor(a/60),c=Number(a%60);e=f+":"+("0"+c).slice(-2)}catch(h){}var p={};for(var d=0;d<t.colkeys.length;d++)p[t.colkeys[d]]="";p.id=r,p.starttime=e,p.duration=0,p.options=t.actions,p.savestatus="unsaved",n.addRow(p),r-=1,l()}function h(){e.all("a[id^='save']").each(function(e){e.on("click",function(e){e.preventDefault(),f(e.currentTarget)})}),e.all("a[id^='delete']").each(function(e){e.on("click",function(e){e.preventDefault(),a(e.currentTarget)})})}function p(){for(var n=0;n<t.data.length;n++)t.data[n].options=t.actions;u(),h(),e.one("#addrow").on("click",function(e){e.preventDefault(),c()}),new e.Resize({node:"#page-mod-klassenbuch-classplan textarea"})}var n,r=-1;p()}},"@VERSION@",{requires:["node","event-key","io","datatype-date","datatable","sortable","datatable-mutable","gallery-datatable-editable","gallery-datatable-celleditor-popup","gallery-datatable-celleditor-inline","resize"]});
